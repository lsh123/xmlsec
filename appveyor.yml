# Continuous Integration script for xmlsec
# Author: Peter Budai <peterbudai@hotmail.com>

# In order to enable appveyor CI in your GitHub repository, please follow the steps
# described in Appyors's Getting Started:  https://www.appveyor.com/docs/
#
# After you add your project to Appveyor, it will recognize this script, and will
# launch the first build process. Every build runs on a fresh virtual machine which is
# not shared with other builds and the state of which is not preserved between consequent
# builds. After the build is finished its virtual machine is decommissioned.
#
# You can check the whole build process in the logs, and any later commit will start
# a new build using a fresh virtual machine.

shallow_clone: true

environment:
  global:
    EXTRAS_FOLDER: C:\extras
    EXTRAS_URL: http://xmlsoft.org/sources/win32/64bit
    ICONV_FILE: iconv-1.14-win32-x86_64.7z
    LIBXML2_FILE: libxml2-2.9.3-win32-x86_64.7z
    LIBXSLT_FILE: libxslt-1.1.28-win32-x86_64.7z

  matrix:
    # enable shared linking
    #- STATIC: no
    #  COMPILER: MinGW-w64

    # enable static linking
    #- STATIC: yes
    #  COMPILER: MinGW-w64

    - APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2017
      STATIC: no
      COMPILER: MSVC17

init:
  - git config --global core.autocrlf input
  - if [%COMPILER%]==[MinGW-w64] set PATH=C:\msys64\usr\bin;C:\msys64\mingw64\bin;%PATH%
  #- if [%COMPILER%]==[MSVC17] 
    
install:
  - if [%COMPILER%]==[MinGW-w64] pacman --noconfirm --sync --refresh --refresh --sysupgrade --sysupgrade
  - if [%COMPILER%]==[MinGW-w64] pacman -S --noconfirm --needed mingw-w64-x86_64-{toolchain,libtool}
  - if [%COMPILER%]==[MinGW-w64] pacman -S --noconfirm --needed mingw-w64-x86_64-{libxml2,libxslt,openssl,gnutls}
  - if [%COMPILER%]==[MSVC17] mkdir %EXTRAS_FOLDER% && cd %EXTRAS_FOLDER%
  - if [%COMPILER%]==[MSVC17] appveyor DownloadFile %EXTRAS_URL%/%ICONV_FILE%
  - if [%COMPILER%]==[MSVC17] 7z x %ICONV_FILE%
  - if [%COMPILER%]==[MSVC17] appveyor DownloadFile %EXTRAS_URL%/%LIBXML2_FILE%
  - if [%COMPILER%]==[MSVC17] 7z x %LIBXML2_FILE%
  - if [%COMPILER%]==[MSVC17] appveyor DownloadFile %EXTRAS_URL%/%LIBXSLT_FILE%
  - if [%COMPILER%]==[MSVC17] 7z x %LIBXSLT_FILE%
  - if [%COMPILER%]==[MSVC17] cd %APPVEYOR_BUILD_FOLDER%

build_script:
  - if [%COMPILER%]==[MinGW-w64] mkdir build && cd build
  - if [%COMPILER%]==[MinGW-w64] bash ../autogen.sh --build="x86_64-w64-mingw32" --host="x86_64-w64-mingw32" --enable-mscrypto --enable-static-linking=$STATIC
  - if [%COMPILER%]==[MinGW-w64] make
  - if [%COMPILER%]==[MSVC17] cd win32
  - if [%COMPILER%]==[MSVC17] cscript configure.js iconv=yes unicode=yes prefix=%EXTRAS_FOLDER% include=%EXTRAS_FOLDER%\include;%MSSDK_INCLUDE% lib=%EXTRAS_FOLDER%\lib;%MSSDK_LIB%
 
test_script:
  - if [%COMPILER%]==[MinGW-w64] make check
