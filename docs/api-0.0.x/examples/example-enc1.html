<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>XML Security Library: Example - Encryption</title>
</head>
<body><table witdh="100%" valign="top"><tr valign="top">
<td valign="top" align="left" width="210">
<img src="../../images/logo.gif" alt="XML Security Library" border="0"><p></p>
<ul>
<li><a href="../../index.html">Home</a></li>
<li><a href="../../download.html">Download</a></li>
<li><a href="../../news.html">News</a></li>
<li><a href="../../documentation.html">Documentation</a></li>
<ul>
<li><a href="../../faq.html">FAQ</a></li>
<li><a href="../../api/xmlsec-notes.html">Tutorial</a></li>
<li><a href="../../api/xmlsec-reference.html">API reference</a></li>
<li><a href="../../api/xmlsec-examples.html">Examples</a></li>
</ul>
<li><a href="../../xmldsig.html">XML Digital Signature</a></li>
<ul><li><a href="../../http://www.aleksey.com/xmlsec/xmldsig-verifier.html">Online Verifier</a></li></ul>
<li><a href="../../xmlenc.html">XML Encryption</a></li>
<li><a href="../../c14n.html">XML Canonicalization</a></li>
<li><a href="../../bugs.html">Reporting Bugs</a></li>
<li><a href="http://www.aleksey.com/pipermail/xmlsec">Mailing list</a></li>
<li><a href="../../related.html">Related</a></li>
</ul>
<table width="100%">
<tr>
<td width="15"></td>
<td><a href="http://xmlsoft.org/"><img src="../../images/libxml2-logo.png" alt="LibXML2" border="0"></a></td>
</tr>
<tr>
<td width="15"></td>
<td><a href="http://xmlsoft.org/XSLT"><img src="../../images/libxslt-logo.png" alt="LibXSLT" border="0"></a></td>
</tr>
<tr>
<td width="15"></td>
<td><a href="http://www.openssl.org/"><img src="../../images/openssl-logo.png" alt="OpenSSL" border="0"></a></td>
</tr>
</table>
</td>
<td valign="top"><table width="100%" valign="top">
<tr><td valign="top" align="left" id="xmlsecContent">
<div align="Center">
      <h2>XML Encryption <br>
                Example 1. Encrypting</h2>
      </div>
<p>
       To encrypt data using XML Security Library the application should:<br>
</p>
<ol>
<li>Create encryption context (depending on the application it could 
   be done once in the beggining of the program).<br>
</li>
        <li>Create or load encryption template that describes the encryption 
   algorithm, encryption key transport mechanism, etc.</li>
        <li>Call one of the encryption functions:<br><ul>
<li><code>xmlSecEncryptMemory()</code></li>
            <li><code>xmlSecEncryptUri()</code></li>
            <li>
<code>xmlSecEncryptXmlNode()</code><br>
</li>
          </ul>
</li>
        <li>Verifiy the result.</li>
      </ol>
<p>
   In this example, we will encrypt a string using DES3 algorithm with 
session  key which will be RSA encrypted and included into the XML document. 
The source  code for this example is included into the package: <a href="examples/enc1/enc1.c">
              source code</a>
        and <a href="examples/enc1/test.xml">the encrypted document</a>
  . <br>
</p>
<h4>Step 0. Initializing LibXML, OpenSSL and XML Security Library.</h4>
<p>
                Before using the libraries we need to initialize them. This 
 should    be  done  once in the beginning of your program<br>
                   <br>
                 <code>   int rnd_seed = 0;    <br><br>
                    /** <br>
                     * Init OpenSSL:<br>
              * this is a BAD way to init random numbers <br>
              * generator<br>
                     */    <br>
                    while (RAND_status() != 1) {<br>
                       RAND_seed(&amp;rnd_seed,
sizeof(rnd_seed));<br>
                    }<br>
                    <br>
                    /**<br>
                     * Init libxml<br>
                     */     <br>
                    xmlInitParser();<br>
                    LIBXML_TEST_VERSION<br>
         </code><br>
            <code> /**<br>
             * Init xmlsec<br>
             */<br>
            xmlSecInit();    <br></code><br>
</p>
<h4>Step 1. Loading key and creating the encryption context.</h4>
<p>
                Before encrypting or decrypting the document you should create
   encryption context     object.  In most case you will need only one
  context object per application<br><br><code> 
            xmlSecKeysMngrPtr keysMngr= NULL; <br>
             xmlSecEncCtxPtr ctx = NULL;<br>
           <br>
            /** <br>
         * Create Keys managers<br>
         */<br>
        keysMngr = xmlSecSimpleKeysMngrCreate();   
        <br>
        if(keysMngr == NULL) {<br>
          fprintf(stderr, "Error: failed to create keys 
 manager\n");<br>
          return(-1);    <br>
        }<br><br>
      <br>
        /**<br>
         * Create enc context<br>
         */<br>
        ctx = xmlSecEncCtxCreate(keysMngr);<br>
        if(ctx == NULL) {<br>
          fprintf(stderr, "Error: template failed to create   context\n");<br>
          return(-1)<br>
        }<br>
        /** <br>
         * load key public rsa key<br>
         */<br>
        if(xmlSecSimpleKeysMngrLoadPemKey(keysMngr, argv[1], NULL, NULL, 0) == NULL) {<br>
          fprintf(stderr, "Error: failed to load key from   \"%s\"\n", argv[1]);<br>
          return(-1);<br>
        }<br>
      <br></code>
      </p>
<h4>Step 2. Creating the template.</h4>
<p>
   In this example we will create encryption template dynamically. However, 
 you can also prepare encryption templates manually, save as XML files and 
 quickly load them into the application. <br><br><code>    xmlNodePtr encKey = NULL;<br>
       xmlNodePtr encData = NULL;<br>
       xmlSecEncResultPtr result = NULL;<br>
       xmlNodePtr cur;<br>
       int ret;<br>
       <br>
       /**<br>
        * Create the EncryptedData node<br>
        */<br>
       encData = xmlSecEncDataCreate(NULL, NULL, NULL, NULL);<br>
       if(encData == NULL) {<br>
         </code><code>fprintf(stderr, "Error: template
 creation failed\n");<br></code><code>    </code><code>  goto done;   
  <br>
       }<br><br>
       /**<br>
        * Set the encryption method<br>
        */<br>
       cur = xmlSecEncDataAddEncMethod(encData, xmlSecEncDes3Cbc);<br>
       if(cur == NULL) {<br>
   fprintf(stderr, "Error: failed to add Enc Method\n");<br>
         goto done;    <br>
       }<br><br>
       /**<br>
        * Add EncryptionProperties node just for fun<br>
        */<br>
       cur = xmlSecEncDataAddEncProperty(encData, BAD_CAST "Classified", 
 NULL);<br>
       if(cur == NULL) {<br>
         fprintf(stderr, "Error: failed to add KeyInfo\n");<br>
         goto done;    <br>
       }<br>
       xmlSetProp(cur, BAD_CAST "Level", BAD_CAST "Top secret: 
 destroy before reading");<br><br>
       /** <br>
        * The encrypted data should be saved in CipherValue 
 node <br>
        */<br>
       cur = xmlSecEncDataAddCipherValue(encData);    
       <br>
       if(cur == NULL) {<br>
         fprintf(stderr, "Error: failed to add CipherValue\n");<br>
         goto done;    <br>
       }<br><br>
       /**<br>
        * Add key info node <br>
        */<br>
       cur = xmlSecEncDataAddKeyInfo(encData);<br>
       if(cur == NULL) {<br>
         fprintf(stderr, "Error: failed to add KeyInfo\n");<br>
         goto done;    <br>
       }<br><br>
       /**<br>
        * The session DES key will be RSA encrypted and 
 included<br>
        * in the message<br>
        */<br>
       encKey = xmlSecKeyInfoAddEncryptedKey(cur, NULL, NULL,
 NULL);<br>
       if(encKey == NULL) {<br>
         fprintf(stderr, "Error: failed to add EncryptedKey\n");<br>
         goto done;    <br>
       }<br>
       <br>
       /**<br>
        * Set the encryption method for encrypting the
 key<br>
        */<br>
       cur = xmlSecEncDataAddEncMethod(encKey, xmlSecEncRsaOaep);<br>
       if(cur == NULL) {<br>
         fprintf(stderr, "Error: failed to add EncryptedKey 
 Enc Method\n");<br>
         goto done;    <br>
       }<br>
       <br>
       /**<br>
        * The encrypted key should be stored in XML document<br>
        */<br>
       cur = xmlSecEncDataAddCipherValue(encKey);    
       <br>
       if(cur == NULL) {<br>
         fprintf(stderr, "Error: failed to add EncryptedKey 
 CipherValue\n");<br>
         goto done;    <br>
       }<br><br>
       /**<br>
        * Now specify the key used to encrypt session 
key<br>
        */<br>
       cur = xmlSecEncDataAddKeyInfo(encKey);<br>
       if(cur == NULL) {<br>
         fprintf(stderr, "Error: failed to add EncryptedKey 
 KeyInfo\n");<br>
         goto done;    <br>
       }<br><br>
       cur = xmlSecKeyInfoAddKeyName(cur);<br>
       if(cur == NULL) {<br>
         fprintf(stderr, "Error: failed to add EncryptedKey 
 KeyName\n");<br>
         goto done;    <br>
       }           <br></code><br>
</p>
<h4>Step 3. Encrypt the data and print result document to stdout.</h4>
<p>
   We are ready to encrypt the document!<br>
    <code>   <br>
       static const char buf[] = "big secret";<br></code><code> <br>
      /**<br>
        * Finally encrypt everything<br>
        */<br>
       ret = xmlSecEncryptMemory(ctx, NULL, NULL, encData, (const unsigned 
 char*)buf,<br>
                    
 strlen(buf), &amp;result);<br>
       if(ret &lt; 0) {<br>
          fprintf(stderr, "Error: memory encryption 
 failed\n");<br>
          goto done;    <br>
       }<br>
       <br>
       /**<br>
        * And print result to stdout<br>
        */           
       <br>
       xmlDocDump(stdout, encData-&gt;doc)</code>
      </p>
<h4>Step 4. Cleanup.</h4>
<p>
                At the end we need to destroy encryption context, the doc 
and  KeysManager;     shutdown XML Security Library, libxml and OpenSSL:<br><br>
                   <code> /*<br>
             * Cleanup<br>
             */   <br>
            if(ctx != NULL) { <br>
               xmlSecEncCtxDestroy(ctx);<br>
            }<br>
            if(keysMngr != NULL) {<br>
               xmlSecSimpleKeysMngrDestroy(keysMngr);<br>
            }<br>
            <br>
            /** <br>
             * Shutdown XML Sec<br>
             */<br>
            xmlSecShutdown();<br><br>
      /**<br>
       * Shutdown libxslt<br>
       */<br>
            xsltCleanupGlobals();</code><br><code><br>
            /* <br>
             * Shutdown libxml<br>
             */<br>
            xmlCleanupParser();<br>
            <br>
            /* <br>
             * Shutdown OpenSSL<br>
             */<br>
            RAND_cleanup();<br>
            ERR_clear_error();</code><code></code><code></code>
      </p>
<h4>Appendix A. The encrypted document.</h4>
<blockquote>
<code>&lt;?xml version="1.0"?&gt;<br>
  &lt;EncryptedData xmlns="http://www.w3.org/2001/04/xmlenc#"&gt;<br>
  &lt;EncryptionMethod Algorithm="http://www.w3.org/2001/04/xmlenc#tripledes-cbc"/&gt;<br>
  &lt;KeyInfo xmlns="http://www.w3.org/2000/09/xmldsig#"&gt;<br>
  &lt;EncryptedKey xmlns="http://www.w3.org/2001/04/xmlenc#"&gt;<br>
  &lt;EncryptionMethod Algorithm="http://www.w3.org/2001/04/xmlenc#rsa-oaep-mgf1p"/&gt;<br>
  &lt;KeyInfo xmlns="http://www.w3.org/2000/09/xmldsig#"&gt;<br>
  &lt;KeyName&gt;test-rsa-key&lt;/KeyName&gt;<br>
  &lt;/KeyInfo&gt;<br>
  &lt;CipherData&gt;<br>
  &lt;CipherValue&gt;<br>
  ETFcDnUPrXyZpaUNDCbe6r6E+YIWmoXBcppWHgv03H+0jIH+w74YKRJh601KUA4u<br>
  KDUK/MbglWQ40FvQ4vhOC4X0uGtWizRllOoZJHn9ppzAcIuwURQOIjCNl9GtrcEx<br>
  14HNIlUoAEXjIbbwSaGCS5u4IdtxzhS2f9P8INh5PkpJjV9EYT73cbX4Cq5e4Yto<br>
  Puox+NUpfOhSfPhTf+41+3u99Nn6oaxlLokfl//lbSE8gD2Yo48cyXN2HkX4tchF<br>
  qOFdCb5bYXA/NmLnrdXXm1Fpuf4QoLDXmbfrCXGF+mHSBkVC1C49FL4ynIVGcBF3<br>
  FibDfsohFvg/ucbDhKHNVQ==<br>
  &lt;/CipherValue&gt;<br>
  &lt;/CipherData&gt;<br>
  &lt;/EncryptedKey&gt;<br>
  &lt;/KeyInfo&gt;<br>
  &lt;CipherData&gt;<br>
  &lt;CipherValue&gt;<br>
  BwP8RHXhJ8xcFVSONxfkwOxhgZNElAmJbaaAdzAIjbk=<br>
  &lt;/CipherValue&gt;<br>
  &lt;/CipherData&gt;<br>
  &lt;EncryptionProperties&gt;<br>
  &lt;EncryptionProperty Id="Classified" Level="Top secret"/&gt;<br>
  &lt;/EncryptionProperties&gt;<br>
  &lt;/EncryptedData&gt;</code><br>
</blockquote>
</td></tr>
<tr><td>
<br><br><p><a href="../../bugs.html">Aleksey Sanin</a></p>
</td></tr>
</table></td>
</tr></table></body>
</html>
