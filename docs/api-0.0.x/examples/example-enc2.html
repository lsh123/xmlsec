<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>XML Security Library: Example - Decryption</title>
</head>
<body><table witdh="100%" valign="top"><tr valign="top">
<td valign="top" align="left" width="210">
<img src="../../images/logo.gif" alt="XML Security Library" border="0"><p></p>
<ul>
<li><a href="../../index.html">Home</a></li>
<li><a href="../../download.html">Download</a></li>
<li><a href="../../news.html">News</a></li>
<li><a href="../../documentation.html">Documentation</a></li>
<ul>
<li><a href="../../faq.html">FAQ</a></li>
<li><a href="../../api/xmlsec-notes.html">Tutorial</a></li>
<li><a href="../../api/xmlsec-reference.html">API reference</a></li>
<li><a href="../../api/xmlsec-examples.html">Examples</a></li>
</ul>
<li><a href="../../xmldsig.html">XML Digital Signature</a></li>
<ul><li><a href="../../http://www.aleksey.com/xmlsec/xmldsig-verifier.html">Online Verifier</a></li></ul>
<li><a href="../../xmlenc.html">XML Encryption</a></li>
<li><a href="../../c14n.html">XML Canonicalization</a></li>
<li><a href="../../bugs.html">Reporting Bugs</a></li>
<li><a href="http://www.aleksey.com/pipermail/xmlsec">Mailing list</a></li>
<li><a href="../../related.html">Related</a></li>
</ul>
<table width="100%">
<tr>
<td width="15"></td>
<td><a href="http://xmlsoft.org/"><img src="../../images/libxml2-logo.png" alt="LibXML2" border="0"></a></td>
</tr>
<tr>
<td width="15"></td>
<td><a href="http://xmlsoft.org/XSLT"><img src="../../images/libxslt-logo.png" alt="LibXSLT" border="0"></a></td>
</tr>
<tr>
<td width="15"></td>
<td><a href="http://www.openssl.org/"><img src="../../images/openssl-logo.png" alt="OpenSSL" border="0"></a></td>
</tr>
</table>
</td>
<td valign="top"><table width="100%" valign="top">
<tr><td valign="top" align="left" id="xmlsecContent">
<div align="Center">
      <h2>XML Encryption <br>
                 Example 1. Decrypting</h2>
      </div>
<p>
        To decrypt data using XML Security Library the application should:<br>
</p>
<ol>
<li>Create decryption context (depending on the application it could
    be done once in the beggining of the program).<br>
</li>
        <li>Call decryption functions:<br><ul>
<li><code>xmlSecDecrypt()</code></li>
          </ul>
</li>
        <li>Verifiy the result and continue decrypted data processing.</li>
      </ol>
<p>
    In this example, we will decrypt XML document encrypted in <a href="example-enc1.html">
 previous example.</a> The <a href="examples/enc2/enc2.c">source code</a>
  for this example is included into the package. <br>
</p>
<h4>Step 0. Initializing LibXML, OpenSSL and XML Security Library.</h4>
<p>
                 Before using the libraries we need to initialize them. This
  should    be  done  once in the beginning of your program<br>
                    <br>
                  <code>   int rnd_seed = 0;   
      <br><br>
                     /** <br>
                      * Init OpenSSL:<br>
               * this is a BAD way to init random numbers
      <br>
               * generator<br>
                      */    <br>
                     while (RAND_status() != 1) {<br>
                        RAND_seed(&amp;rnd_seed, 
sizeof(rnd_seed));<br>
                     }<br>
                     <br>
                     /**<br>
                      * Init libxml<br>
                      */     <br>
                     xmlInitParser();<br>
                     LIBXML_TEST_VERSION<br>
          </code><br>
             <code> /**<br>
              * Init xmlsec<br>
              */<br>
             xmlSecInit();    <br></code><br>
</p>
<h4>Step 1. Loading key and creating the encryption context.</h4>
<p>
                 Before encrypting or decrypting the document you should
create    encryption context     object.  In most case you will need
only one   context object per application<br><br><code>
         xmlSecKeysMngrPtr keysMngr = NULL; <br>
        xmlSecEncCtxPtr ctx = NULL;<br>
                     <br>
             /** <br>
          * Create Keys managers<br>
          */<br>
         keysMngr = xmlSecSimpleKeysMngrCreate();    
        <br>
         if(keysMngr == NULL) {<br>
           fprintf(stderr, &quot;Error: failed to create keys
  manager\n&quot;);<br>
           return(-1);    <br>
         }<br><br>
       <br><br>
         /**<br>
          * Create enc context<br>
          */<br>
         ctx = xmlSecEncCtxCreate(keysMngr);<br>
         if(ctx == NULL) {<br>
           fprintf(stderr, &quot;Error: template failed to create   context\n&quot;);<br>
           return(-1)<br>
         }<br><br>
         /** <br>
          * load key private rsa key<br>
          */<br>
         if(xmlSecSimpleKeysMngrLoadPem(keysMgr, argv[1],  NULL, NULL, 1) == NULL) {<br>
           fprintf(stderr, &quot;Error: failed to load key   from   \&quot;%s\&quot;\n&quot;, argv[1]);<br>
           return(-1);<br>
         }<br><br></code>
      </p>
<h4>Step 2. Load the document, decrypt and print result document to
stdout.</h4>
<p>
    We are ready to decrypt the document!<br>
     <code>   <br>
        xmlDocPtr doc = NULL;<br>
    xmlSecEncResultPtr result = NULL;<br>
    int ret;<br><br><br>
    /*<br>
     * build an XML tree from a the file; we need to
add default<br>
     * attributes and resolve all character and entities
references<br>
     */<br>
    xmlLoadExtDtdDefaultValue = XML_DETECT_IDS | XML_COMPLETE_ATTRS;<br>
    xmlSubstituteEntitiesDefault(1);<br><br>
    doc = xmlParseFile(filename);<br>
    if (doc == NULL) {<br>
       fprintf(stderr, &quot;Error: unable to parse file \&quot;%s\&quot;\n&quot;,
filename);<br>
       goto done;    <br>
    }<br>
    <br>
    /*<br>
     * Check the document is of the right kind<br>
     */    <br>
    if(xmlDocGetRootElement(doc) == NULL) {<br>
       fprintf(stderr,&quot;Error: empty document for file
\&quot;%s\&quot;\n&quot;, filename);<br>
       goto done;    <br>
    }<br>
    <br>
    /** <br>
     * Decrypt<br>
     */<br>
    ret = xmlSecDecrypt(ctx, NULL, NULL, xmlDocGetRootElement(doc), &amp;result);<br>
    if(ret &lt; 0) {<br>
       fprintf(stderr, &quot;Error: decryption failed\n&quot;);<br>
       goto done;    <br>
    }<br>
    <br>
    /**<br>
     * And print result to stdout<br>
     */           
     <br>
     ret = fwrite(xmlBufferContent(result-&gt;buffer),xmlBufferLength(result-&gt;buffer),<br>
                 
1, stdout);     </code><code></code>
      </p>
<h4>Step 3. Cleanup.</h4>
<p>
                 At the end we need to destroy encryption context, the doc
 and  KeysManager;     shutdown XML Security Library, libxml and OpenSSL:<br><br>
                    <code> /*<br>
              * Cleanup<br>
              */   <br>
             if(ctx != NULL) { <br>
                xmlSecEncCtxDestroy(ctx);<br>
             }<br>
             if(keysMngr != NULL) {<br>
                xmlSecSimpleKeysMngrDestroy(keysMngr);<br>
             }<br>
             <br>
             /** <br>
              * Shutdown XML Sec<br>
              */<br>
             xmlSecShutdown();<br><br>
       /**<br>
        * Shutdown libxslt<br>
        */<br>
             xsltCleanupGlobals();</code><br><code><br>
             /* <br>
              * Shutdown libxml<br>
              */<br>
             xmlCleanupParser();<br>
             <br>
             /* <br>
              * Shutdown OpenSSL<br>
              */<br>
             RAND_cleanup();<br>
             ERR_clear_error();</code><code></code><code></code>
      </p>
<h4>Appendix A. The encrypted document.</h4>
<blockquote><code>&lt;?xml version=&quot;1.0&quot;?&gt;<br>
   &lt;EncryptedData xmlns=&quot;http://www.w3.org/2001/04/xmlenc#&quot;&gt;<br>
   &lt;EncryptionMethod Algorithm=&quot;http://www.w3.org/2001/04/xmlenc#aes128-cbc&quot;/&gt;<br>
   &lt;KeyInfo xmlns=&quot;http://www.w3.org/2000/09/xmldsig#&quot;&gt;<br>
   &lt;EncryptedKey xmlns=&quot;http://www.w3.org/2001/04/xmlenc#&quot;&gt;<br>
   &lt;EncryptionMethod Algorithm=&quot;http://www.w3.org/2001/04/xmlenc#rsa-oaep-mgf1p&quot;/&gt;<br>
   &lt;KeyInfo xmlns=&quot;http://www.w3.org/2000/09/xmldsig#&quot;&gt;<br>
   &lt;KeyName&gt;test-rsa-key&lt;/KeyName&gt;<br>
   &lt;/KeyInfo&gt;<br>
   &lt;CipherData&gt;<br>
   &lt;CipherValue&gt;<br>
   ETFcDnUPrXyZpaUNDCbe6r6E+YIWmoXBcppWHgv03H+0jIH+w74YKRJh601KUA4u<br>
   KDUK/MbglWQ40FvQ4vhOC4X0uGtWizRllOoZJHn9ppzAcIuwURQOIjCNl9GtrcEx<br>
   14HNIlUoAEXjIbbwSaGCS5u4IdtxzhS2f9P8INh5PkpJjV9EYT73cbX4Cq5e4Yto<br>
   Puox+NUpfOhSfPhTf+41+3u99Nn6oaxlLokfl//lbSE8gD2Yo48cyXN2HkX4tchF<br>
   qOFdCb5bYXA/NmLnrdXXm1Fpuf4QoLDXmbfrCXGF+mHSBkVC1C49FL4ynIVGcBF3<br>
   FibDfsohFvg/ucbDhKHNVQ==<br>
   &lt;/CipherValue&gt;<br>
   &lt;/CipherData&gt;<br>
   &lt;/EncryptedKey&gt;<br>
   &lt;/KeyInfo&gt;<br>
   &lt;CipherData&gt;<br>
   &lt;CipherValue&gt;<br>
   BwP8RHXhJ8xcFVSONxfkwOxhgZNElAmJbaaAdzAIjbk=<br>
   &lt;/CipherValue&gt;<br>
   &lt;/CipherData&gt;<br>
   &lt;EncryptionProperties&gt;<br>
   &lt;EncryptionProperty Id=&quot;Classified&quot; Level=&quot;Top secret&quot;/&gt;<br>
   &lt;/EncryptionProperties&gt;<br>
   &lt;/EncryptedData&gt;
        </code></blockquote>
</td></tr>
<tr><td>
<br><br><p><a href="../../bugs.html">Aleksey Sanin</a></p>
</td></tr>
</table></td>
</tr></table></body>
</html>
